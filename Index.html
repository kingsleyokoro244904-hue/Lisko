<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dues Tracker</title>
<style>
  body{font-family:Arial, sans-serif;background:#f4f6f9;margin:0;padding:20px;color:#222}
  .container{max-width:1100px;margin:0 auto;background:#fff;padding:18px;border-radius:10px;box-shadow:0 6px 20px rgba(0,0,0,0.08)}
  h1{color:#0b5fff;text-align:center}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
  input,select,button{padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px}
  button{background:#0b5fff;color:#fff;border:none;cursor:pointer}
  button.secondary{background:#6b7280}
  table{width:100%;border-collapse:collapse;margin-top:15px}
  th,td{border:1px solid #ddd;padding:8px;text-align:center}
  th{background:#0b5fff;color:#fff}
  .paid{color:#0a8a2e;font-weight:bold}
  .due{color:#0a44d6;font-weight:bold}
  .owe{color:#c81f1f;font-weight:bold}
  .totals{margin-top:15px;padding:12px;background:#eef5ff;border-radius:8px}
  .actions button{padding:4px 6px;font-size:12px;margin:0 2px}
  .danger{background:#d11a2a}
  .note{font-size:13px;color:#444;margin-top:4px}
</style>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b5fff">
</head>
<body>
<div class="container">
  <h1 id="pageTitle">Your Organization Name ‚Äî Dues Tracker</h1>

  <!-- Org Name -->
  <div class="row">
    <input id="orgNameInput" placeholder="Enter organization name">
    <button onclick="saveOrg()">Save Org Name</button>
  </div>

  <!-- Add Member -->
  <div class="row">
    <input id="newMember" placeholder="New member name">
    <button onclick="addMember()">Add Member</button>
    <button class="secondary" onclick="clearAll()">Clear All Data</button>
  </div>

  <!-- Add Payment -->
  <div class="row">
    <select id="memberSelect"></select>
    <select id="monthSelect">
      <option value="">Select month</option>
      <option>January</option><option>February</option><option>March</option>
      <option>April</option><option>May</option><option>June</option>
      <option>July</option><option>August</option><option>September</option>
      <option>October</option><option>November</option><option>December</option>
    </select>
    <input id="paymentType" placeholder="Payment type">
    <input id="amountPaid" type="number" placeholder="Paid">
    <input id="paymentDue" type="number" placeholder="Due">
    <button onclick="addPayment()">Add Payment</button>
  </div>

  <!-- Export -->
  <div class="row">
    <label>Export month
      <select id="exportMonth" style="margin-left:8px">
        <option value="All">All</option>
        <option>January</option><option>February</option><option>March</option>
        <option>April</option><option>May</option><option>June</option>
        <option>July</option><option>August</option><option>September</option>
        <option>October</option><option>November</option><option>December</option>
      </select>
    </label>
    <button onclick="exportPDF()">üìÑ Export as PDF</button>
  </div>

  <!-- Table -->
  <table id="duesTable">
    <thead>
      <tr><th>Member</th><th>Month</th><th>Type</th><th>Paid</th><th>Due</th><th>Owe</th><th>Actions</th></tr>
    </thead>
    <tbody></tbody>
  </table>

  <div class="totals">
    <div id="totalContributed" class="paid">Total contributed: ‚Ç¶0</div>
    <div id="totalOwed" class="owe">Total owed: ‚Ç¶0</div>
  </div>
</div>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
let records = JSON.parse(localStorage.getItem("duesRecords") || "[]");
let members = JSON.parse(localStorage.getItem("membersList") || "[]");
const monthOrder = {January:1,February:2,March:3,April:4,May:5,June:6,July:7,August:8,September:9,October:10,November:11,December:12};

function saveOrg(){
  const v=document.getElementById("orgNameInput").value.trim()||"Your Organization Name";
  localStorage.setItem("orgName",v);
  document.getElementById("pageTitle").textContent=v+" ‚Äî Dues Tracker";
}

function addMember(){
  const name=document.getElementById("newMember").value.trim();
  if(!name){alert("Enter name");return;}
  if(members.includes(name)){alert("Already exists");return;}
  members.push(name);save();renderMembers();document.getElementById("newMember").value="";
}

function renderMembers(){
  const sel=document.getElementById("memberSelect");
  sel.innerHTML="";
  members.forEach(m=>{
    const opt=document.createElement("option");opt.value=m;opt.textContent=m;sel.appendChild(opt);
  });
}

function addPayment(){
  const name=document.getElementById("memberSelect").value;
  const month=document.getElementById("monthSelect").value;
  const type=document.getElementById("paymentType").value.trim();
  const paid=parseFloat(document.getElementById("amountPaid").value);
  const due=parseFloat(document.getElementById("paymentDue").value);
  if(!name||!month||!type||isNaN(paid)||isNaN(due)){alert("Fill all fields");return;}
  const owe=Math.max(due-paid,0);
  records.push({id:Date.now(),name,month,type,paid,due,owe});
  save();renderTable();
  document.getElementById("amountPaid").value="";
  document.getElementById("paymentDue").value="";
  document.getElementById("paymentType").value="";
  document.getElementById("monthSelect").value="";
}

function editRecord(id){
  const r=records.find(x=>x.id===id);if(!r)return;
  const newPaid=prompt("New paid:",r.paid);
  const newDue=prompt("New due:",r.due);
  if(newPaid===null||newDue===null)return;
  r.paid=parseFloat(newPaid)||0;r.due=parseFloat(newDue)||0;r.owe=Math.max(r.due-r.paid,0);
  save();renderTable();
}

function deleteRecord(id){
  if(!confirm("Delete?"))return;
  records=records.filter(r=>r.id!==id);save();renderTable();
}

function clearAll(){
  if(confirm("Erase ALL?")){records=[];members=[];save();renderMembers();renderTable();}
}

function save(){
  localStorage.setItem("duesRecords",JSON.stringify(records));
  localStorage.setItem("membersList",JSON.stringify(members));
}

function renderTable(){
  const tbody=document.querySelector("#duesTable tbody");
  tbody.innerHTML="";
  let totalPaid=0,totalOwe=0;

  // group by member
  const grouped={};
  records.forEach(r=>{
    if(!grouped[r.name]) grouped[r.name]=[];
    grouped[r.name].push(r);
  });

  for(const [member,arr] of Object.entries(grouped)){
    arr.sort((a,b)=>monthOrder[a.month]-monthOrder[b.month]);
    let mp=0,md=0,mo=0;
    arr.forEach(r=>{
      mp+=r.paid;md+=r.due;mo+=r.owe;totalPaid+=r.paid;totalOwe+=r.owe;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.name}</td><td>${r.month}</td><td>${r.type}</td>
        <td class="paid">‚Ç¶${r.paid}</td><td class="due">‚Ç¶${r.due}</td><td class="owe">‚Ç¶${r.owe}</td>
        <td class="actions">
          <button onclick="editRecord(${r.id})">‚úè</button>
          <button class="danger" onclick="deleteRecord(${r.id})">üóë</button>
        </td>`;
      tbody.appendChild(tr);
    });
    // total row for member
    const tr=document.createElement("tr");
    tr.innerHTML=`<td><b>Total for ${member}</b></td><td></td><td></td>
      <td class="paid"><b>‚Ç¶${mp}</b></td>
      <td class="due"><b>‚Ç¶${md}</b></td>
      <td class="owe"><b>‚Ç¶${mo}</b></td>
      <td></td>`;
    tbody.appendChild(tr);
  }

  document.getElementById("totalContributed").textContent="Total contributed: ‚Ç¶"+totalPaid;
  document.getElementById("totalOwed").textContent="Total owed: ‚Ç¶"+totalOwe;
}

// --- PDF Export ---
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc=new jsPDF();
  const filter=document.getElementById("exportMonth").value;
  const orgName=localStorage.getItem("orgName")||"Your Organization Name";

  doc.setFontSize(16);doc.text(orgName,105,20,null,null,"center");
  doc.setFontSize(13);doc.text("Dues Report ("+filter+")",105,30,null,null,"center");

  const data=records.filter(r=>filter==="All"||r.month===filter);
  const grouped={};data.forEach(r=>{if(!grouped[r.name])grouped[r.name]=[];grouped[r.name].push(r);});

  let grandP=0,grandD=0,grandO=0;
  let startY=40;

  for(const [member,arr] of Object.entries(grouped)){
    arr.sort((a,b)=>monthOrder[a.month]-monthOrder[b.month]);
    let mp=0,md=0,mo=0;

    const rows=[];
    arr.forEach(r=>{
      mp+=r.paid;md+=r.due;mo+=r.owe;
      grandP+=r.paid;grandD+=r.due;grandO+=r.owe;
      rows.push([r.month,r.type,
        {content:"‚Ç¶"+r.paid,styles:{textColor:[0,128,0]}},
        {content:"‚Ç¶"+r.due,styles:{textColor:[0,0,200]}},
        {content:"‚Ç¶"+r.owe,styles:{textColor:[200,0,0]}}
      ]);
    });
    // member total row
    rows.push([
      "","Total for "+member,
      {content:"‚Ç¶"+mp,styles:{textColor:[0,128,0],fontStyle:"bold"}},
      {content:"‚Ç¶"+md,styles:{textColor:[0,0,200],fontStyle:"bold"}},
      {content:"‚Ç¶"+mo,styles:{textColor:[200,0,0],fontStyle:"bold"}}
    ]);

    doc.autoTable({
      head:[[member,"Type","Paid","Due","Owe"]],
      body:rows,
      startY:startY,
      styles:{fontSize:9,halign:"center"},
      headStyles:{fillColor:[11,95,255],textColor:[255,255,255]},
      alternateRowStyles:{fillColor:[245,250,255]}
    });
    startY=doc.lastAutoTable.finalY+10;
  }

  // grand totals
  doc.autoTable({
    body:[[
      "Grand Totals",
      {content:"‚Ç¶"+grandP,styles:{textColor:[0,128,0],fontStyle:"bold"}},
      {content:"‚Ç¶"+grandD,styles:{textColor:[0,0,200],fontStyle:"bold"}},
      {content:"‚Ç¶"+grandO,styles:{textColor:[200,0,0],fontStyle:"bold"}}
    ]],
    startY:startY,
    styles:{fontSize:11,halign:"center"},
    theme:"grid",
    head:[["","Paid","Due","Owe"]],
    headStyles:{fillColor:[40,167,69],textColor:[255,255,255]}
  });

  doc.save("Dues_Report.pdf");
}

renderMembers();renderTable();
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("service-worker.js")
    .then(() => console.log("Service Worker registered!"))
    .catch(err => console.error("SW registration failed:", err));
}
</script>
</body>
</html>
